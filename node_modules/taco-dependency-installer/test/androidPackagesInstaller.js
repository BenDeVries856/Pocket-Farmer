/**
 *******************************************************
 *                                                     *
 *   Copyright (C) Microsoft. All rights reserved.     *
 *                                                     *
 *******************************************************
 */
/// <reference path="../../typings/dependencyInstallerInterfaces.d.ts"/>
/// <reference path="../../typings/lodash.d.ts"/>
/// <reference path="../../typings/mocha.d.ts"/>
/// <reference path="../../typings/mockery.d.ts"/>
/// <reference path="../../typings/mock-fs.d.ts"/>
/// <reference path="../../typings/nodeFakes.d.ts"/>
/// <reference path="../../typings/should.d.ts"/>
/// <reference path="../../typings/tacoTestsUtils.d.ts"/>
/// <reference path="../../typings/telemetryFakes.d.ts"/>
"use strict";
/* tslint:disable:no-var-requires */
// var require needed for should module to work correctly
// Note not import: We don't want to refer to shouldModule, but we need the require to occur since it modifies the prototype of Object.
var shouldModule = require("should");
var FakeLogger = require("./fakeLogger");
var _ = require("lodash");
var mockery = require("mockery");
var mockFs = require("mock-fs");
var path = require("path");
var Q = require("q");
var tacoTestsUtils = require("taco-tests-utils");
var nodeFakes = tacoTestsUtils.NodeFakes;
describe("AndroidPackagesInstaller telemetry", function () {
    // Parameters for AndroidSdkInstaller
    var steps;
    var installerInfo = {
        installSource: "",
        sha1: "",
        bytes: 0,
        installDestination: "",
        steps: steps
    };
    var softwareVersion = "";
    var installTo = "C:\\Program Files (x86)\\Android"; // Default installation directory in windows
    // Mocks used by the tests
    var mockPath;
    var fakeTelemetryHelper;
    var fakeProcess;
    var androidPackagesInstallerClass;
    var childProcessModule;
    var androidSdkPackages = "----------\n    id: 3 or \"sys-img-x86-addon-google_apis-google-23\"\n    Type: SystemImage\n    Desc: System Image x86 with Google APIs.\n        Revision 8\n    Requires SDK Platform Android API 23\n    ----------\n    id: 4 or \"extra-android-m2repository\"\n    Type: Extra\n    Desc: Android Support Repository, revision 24\n    By Android\n    Local Maven repository for Support Libraries\n           Install path: extrasandroidm2repository\n    ----------\n    id: 5 or \"extra-android-support\"\n    Type: Extra\n    Desc: Android Support Library, revision 23.1\n    By Android\n    Install path: extrasandroidsupport";
    before(function () {
        // We tell mockery to replace "require()" with our own custom mock objects
        mockery.enable({ useCleanCache: true, warnOnUnregistered: false });
        fakeProcess = new nodeFakes.Process().fakeDeterministicHrtime();
        var fakeProcessUtilsModule = { ProcessUtils: fakeProcess.buildProcessUtils() };
        mockery.registerMock("./processUtils", fakeProcessUtilsModule); // TelemetryHelper loads ./processUtils
        var tacoUtils = require("taco-utils");
        tacoUtils.Telemetry.init("TACO/dependencyInstaller", "1.2.3", { isOptedIn: false });
        // Register mocks. child_process and taco-utils mocks needs to be registered before 
        // AndroidSdkInstaller is required for the mocking to work
        childProcessModule = new nodeFakes.ChildProcessModule().fakeAllExecCallsEndingWithErrors();
        mockery.registerMock("child_process", childProcessModule);
        // Reload taco-tests-utils but now with the fake processUtils loaded, so the fake telemetry will use the fake process
        var tacoTestsUtilsWithMocks = require("taco-tests-utils");
        fakeTelemetryHelper = new tacoTestsUtilsWithMocks.TelemetryFakes.Helper();
        var tacoUtilsWithFakes = _.extend({}, tacoUtils, { TelemetryHelper: fakeTelemetryHelper, HasFakes: true }, fakeProcessUtilsModule);
        mockery.registerMock("taco-utils", tacoUtilsWithFakes); // AndroidSdkInstaller loads taco-utils
        // We need to mock path if we want to run windows tests on a mac, so it'll use ; as path delimiter
        mockPath = _.extend({}, path);
        mockery.registerMock("path", mockPath); // installerUtils uses path.delimiter, and it breaks the Windows tests on mac if not
        // We require the AndroidPackagesInstaller file, which will use all the mocked dependencies
        androidPackagesInstallerClass = require("../installers/androidPackagesInstaller");
    });
    after(function () {
        // Clean up and revert everything back to normal
        mockery.deregisterAll();
        mockery.disable();
        mockFs.restore();
    });
    beforeEach(function () {
        fakeTelemetryHelper.clear(); // So we'll only get the new events in each scenario
        steps = { download: false, install: false, updateVariables: false, postInstall: false }; // We reset all the steps to false
        fakeProcess.clearEnv(); // Reset environment variables, given that we modify some of them in the tests
    });
    function telemetryGeneratedShouldBe(expectedTelemetry, expectedMessagePattern, done) {
        var androidPackagesInstaller = new androidPackagesInstallerClass(installerInfo, softwareVersion, installTo, new FakeLogger(), steps);
        return androidPackagesInstaller.run()
            .then(function () { return Q.reject(new Error("Should have gotten a rejection in this test")); }, function (error) {
            return fakeTelemetryHelper.getAllSentEvents().then(function (allSentEvents) {
                // We check the message first, because some coding defects can make the tests end in unexpected states
                error.message.should.match(expectedMessagePattern);
                // Then we validate the telemetry
                allSentEvents.should.eql(expectedTelemetry);
            });
        }).done(done, done);
    }
    describe("in windows", function () {
        beforeEach(function () {
            fakeProcess.fakeWindows();
            mockPath.delimiter = ";"; // Installer utils uses this, and the path logic breaks in Mac if we don't mock it
            steps.install = true; // We only test this step on this test
            // Set ANDROID_HOME so updateVariables won't try to re-set it
            installTo = "C:\\Program Files (x86)\\Android"; // We don't have an install location
            var androidHomePath = fakeProcess.env.ANDROID_HOME = mockPath.join(installTo, "android-sdk-windows");
            // Set android paths in the PATH so we won't have to add them
            var platformToolsPath = mockPath.join(androidHomePath, "platform-tools");
            var androidToolsPath = mockPath.join(androidHomePath, "tools");
            fakeProcess.env.PATH = platformToolsPath + mockPath.delimiter + androidToolsPath;
            // Create a fake project.properties file
            var projectPropertiesPath = path.join("platforms", "android", "project.properties");
            // Fake resources file
            var baseDirName = path.dirname(__dirname);
            var resourcesPath = path.join(baseDirName, "resources", "en", "resources.json");
            var files = {};
            files[projectPropertiesPath] = "target=sys-img-x86-addon-google_apis-google-23";
            files[resourcesPath] = "{}";
            mockFs(files);
        });
        it("reports telemetry when getAvailableAndroidPackages fails emiting error", function (done) {
            var spawnErrorMessage = "The command is not recognized by the system";
            childProcessModule.mockSpawn.setDefault(function (callback) {
                /* Warning: The "this" in the next line is the one passed by mockSpawn library. For that
                   to work this context needs to be a JavaScript lambda function. Do not convert this to
                   an arrow function, or this will break because of the change in semantics. */
                this.emit("error", new Error(spawnErrorMessage)); // invokes childProcess.on('error')
                setTimeout(function () { return callback(0); }, 0); // Then the child process ends with an arbitrary error code of 8
            });
            var expectedTelemetry = [
                {
                    "initialStep.time": { isPii: false, value: "2000" },
                    step: { isPii: false, value: "initialStep" }
                },
                {
                    "error.description": {
                        isPii: false,
                        value: "ErrorOnChildProcess on getAvailableAndroidPackages"
                    },
                    "install.time": { isPii: false, value: "2000" },
                    lastStepExecuted: { isPii: false, value: "install" },
                    step: { isPii: false, value: "install" },
                    time: { isPii: false, value: "3000" }
                }
            ];
            return telemetryGeneratedShouldBe(expectedTelemetry, new RegExp(spawnErrorMessage), done);
        });
        it("reports telemetry when getAvailableAndroidPackages fails with error code", function (done) {
            childProcessModule.mockSpawn.setDefault(function (callback) {
                setTimeout(function () { return callback(8); }, 0); // Then the child process ends with an arbitrary error code of 8
            });
            var expectedTelemetry = [
                {
                    "initialStep.time": { isPii: false, value: "2000" },
                    step: { isPii: false, value: "initialStep" }
                },
                {
                    "error.code": { isPii: false, value: "8" },
                    "error.description": {
                        isPii: false,
                        value: "ErrorOnExitOfChildProcess on getAvailableAndroidPackages"
                    },
                    "error.message": { isPii: true, value: "" },
                    "install.time": { isPii: false, value: "2000" },
                    lastStepExecuted: { isPii: false, value: "install" },
                    step: { isPii: false, value: "install" },
                    time: { isPii: false, value: "3000" }
                }
            ];
            return telemetryGeneratedShouldBe(expectedTelemetry, /^$/, done); // We don't have an error message
        });
        it("reports telemetry when killing adb is not recognized as a command", function (done) {
            // First two calls to list and install the android packages will succeed
            childProcessModule.mockSpawn.sequence.add(childProcessModule.mockSpawn.simple(/*exitCode*/ 0, /*stdout*/ androidSdkPackages, /*stderr*/ ""));
            childProcessModule.mockSpawn.sequence.add(childProcessModule.mockSpawn.simple(/*exitCode*/ 0, /*stdout*/ androidSdkPackages, /*stderr*/ ""));
            // Third call to kill adb will fail
            var spawnErrorMessage = "The kill adb command is not recognized by the system";
            childProcessModule.mockSpawn.sequence.add(function (callback) {
                /* Warning: The "this" in the next line is the one passed by mockSpawn library. For that
                   to work this context needs to be a JavaScript lambda function. Do not convert this to
                   an arrow function, or this will break because of the change in semantics. */
                this.emit("error", new Error(spawnErrorMessage)); // invokes childProcess.on('error')
                setTimeout(function () { return callback(0); }, 0); // Then the child process ends with an arbitrary error code of 0
            });
            var expectedTelemetry = [
                {
                    "initialStep.time": { isPii: false, value: "2000" },
                    step: { isPii: false, value: "initialStep" }
                },
                {
                    "error.description": { isPii: false, value: "ErrorOnKillingAdb in killAdb" },
                    "install.time": { isPii: false, value: "2000" },
                    lastStepExecuted: { isPii: false, value: "install" },
                    step: { isPii: false, value: "install" },
                    time: { isPii: false, value: "3000" }
                }
            ];
            return telemetryGeneratedShouldBe(expectedTelemetry, new RegExp(spawnErrorMessage), done);
        });
    });
});

//# sourceMappingURL=androidPackagesInstaller.js.map
